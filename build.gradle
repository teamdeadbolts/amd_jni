/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details on building Java & JVM projects, please refer to https://docs.gradle.org/9.0.0/userguide/building_java_projects.html in the Gradle documentation.
 */

plugins {
	id "java"
  id "maven-publish"
	id 'edu.wpi.first.WpilibTools' version '2.1.0'
	id "com.diffplug.spotless" version "7.0.1"
	id "edu.wpi.first.GradleRIO" version "2025.3.2"
}

group = 'org.teamdeadbolts'
version = '0.0.4-dev'

allprojects {
  repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
    mavenLocal()
  }
}

ext {
  wpilibVersion = "2025.3.2"
  wpimathVersion = wpilibVersion
  openCVversion = "4.10.0-3"
}


wpi.getVersions().getOpencvVersion().convention(openCVversion);
wpi.getVersions().getWpilibVersion().convention(wpilibVersion);
wpi.getVersions().getWpimathVersion().convention(wpimathVersion);
wpilibTools.deps.wpilibVersion = wpilibVersion

java {
  sourceCompatibility = JavaVersion.VERSION_17
  targetCompatibility = JavaVersion.VERSION_17

  toolchain {
    languageVersion = JavaLanguageVersion.of(17)
  }
}

dependencies {
	implementation wpilibTools.deps.wpilibJava("wpiutil")
	implementation wpilibTools.deps.wpilibOpenCvJava("frc" + wpi.frcYear.get(), wpi.versions.opencvVersion.get())
	
  testImplementation libs.junit.jupiter
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}


ext.nativeName = wpilibTools.platformMapper.currentPlatform.platformName;

ext.outputsFolder = file("$buildDir/outputs");

println("Building for platform $nativeName");

tasks.named('test') {
	useJUnitPlatform()

	testLogging {
		showStandardStreams = true
	}

	def parts = []
	parts << "$buildDir/outputs/nativelibraries/$nativeName"
	def ldPath = System.getenv("LD_LIBRARY_PATH")
	if (ldPath != null) parts << ldPath
	parts << System.getProperty("java.library.path")

	systemProperty "java.library.path", parts.join(File.pathSeparator)
}


tasks.register('buildNative', Exec) {
  workingDir "$projectDir"
  commandLine 'cmake', '--build', 'cmake_build'
}

tasks.register('copyNative', Copy) {
  dependsOn buildNative
  from "$projectDir/cmake_build"
  into "$outputsFolder/nativelibraries/$nativeName"
  include "*.so"

  eachFile {
    println("Copying native library: $name");
    path = name;
  }
  includeEmptyDirs = false
}

tasks.register("generateJniHeaders", JavaCompile) {
	group = "build"
	description = "Generates JNI headers for AmdJNI"

	source = fileTree("src/main/java") {
		include "org/teamdeadbolts/amd/AmdJNI.java"
	}

	classpath = sourceSets.main.compileClasspath
	destinationDirectory = file("$buildDir/classes/java/main")
	options.compilerArgs = [
		"-h", "$projectDir/src/main/native/include"
	]
}

build.dependsOn copyNative
test.dependsOn copyNative

def nativeConfigName = "wpilibNatives"
def nativeConfig = configurations.create(nativeConfigName)

def nativeTasks = wpilibTools.createExtractionTasks {
configurationName = nativeConfigName
}

jar {
  dependsOn copyNative

  from("$outputsFolder/nativelibraries/$nativeName") {
    into "nativelibraries/$nativeName"
  }

  manifest {
    attributes(
      'Implementation-Title': 'AMD JNI',
      'Implementation-Version': version,
      'Native-Platform': nativeName,
    )
  }
}

publishing {
  publications {
    maven(MavenPublication) {
      from components.java

      groupId = 'org.teamdeadbolts'
      artifactId = "amd_jni-${nativeName}"
      version = project.version

      pom {
        name = 'AMD JNI'
        description = 'Java bindings for AMD object detection library'
        url = 'https://github.com/teamdeadbolts/amd_jni'

        licenses {
          license {
            name = 'The MIT License'
            url = 'https://opensource.org/license/mit/'
          }
        }

        developers {
          developer {
            id = 'totaltaxamount'
            name = 'TotalTaxAmount'
          }
        }
      }
    }
  }

  repositories {
    // maven {
    //   name = 'Local'
    //   url = mavenLocal().url
    // }

    maven {
      name = 'GitHubPackages'
      url = uri('https://maven.pkg.github.com/teamdeadbolts/amd_jni')
      credentials {
        username = System.getenv("GITHUB_ACTOR");
        password = System.getenv("GITHUB_TOKEN");
      }
    }
  }
}

spotless {
	format 'misc', {
		target '.gitignore', '*.json'

		trimTrailingWhitespace()
		leadingSpacesToTabs()
		endWithNewline()
	}

	java {
		googleJavaFormat('1.25.2').aosp().reflowLongStrings() // Google formatting is probably good
		formatAnnotations()

		licenseHeader '/* Team Deadbolts (C) $YEAR */'
	}
}
